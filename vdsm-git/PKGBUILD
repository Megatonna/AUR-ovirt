# Contributor: Andrii Sokolenko
# Based by Ovirt vdsm.spec
pkgname=vdsm-git
pkgver=4.18.999.442.git0bb7717
pkgrel=0
pkgdesc="Virtual Desktop Server Manager"
arch=('i686' 'x86_64')
url="https://www.ovirt.org/develop/developer-guide/vdsm/vdsm/"
license=('GPLv2+')
groups=()
depends=('python' 'python-nose' 'python-mock' 'python-netaddr' 'python-six' \
         'libsasl' 'dosfstools' 'libnl' 'libvirt-python' 'mom' \
         'openssl' 'psmisc' 'python-yaml' 'python2-yaml' 'python-pyinotify' 'qemu' 'sanlock' \
         'openvswitch' 'systemd' 'libvirt' 'libvirt-python' 'gettext' 'autoconf' \
         'automake' 'libtool' 'dmidecode' 'python-dmidecode' 'ethtool' 'which' 'sudo' \
         'logrotate' 'xz' 'ntp' 'iproute' 'python-argparse' 'python-requests' 'nfs-utils' 'curl' \
         'lvm2' 'e2fsprogs' 'ed' 'sed' 'openvswitch' 'bridge-utils' 'tree' 'networkmanager' 'usbutils' \
         'python2-cpopen' 'python3-ioprocess')
makedepends=('')
provides=('vdsm' 'vdsm-cli' 'vdsm-xmlrpm' 'vdsm-api' 'vdsm-jsonrpc' 'vdsm-yajsonrpc' \ 
          'vdsm-python' 'vdsm-tests' 'vdsm-hook-allocate_net' 'vdsm-hook-checkimages' \
          'vdsm-hook-checkips' 'vdsm-hook-diskunmap' 'vdsm-hook-ethtool-options')

#fence-agents-all ??? - ilo, apc ...
#initscripts ???
#virt-v2v
#sanlock-python
#python-pthreading
#rpm-python
#genisoimage
#rpm-build
#m2crypto
#safelease  -ovirt
#shadow-utils - usermod/passwd/etc
#ovirt-imageio-common(with_ovirt_imageio)
#ovirt-imageio-daemon(with_ovirt_imageio)
#ovirt-vmconsole(with_ovirt_vmconsole)
#libvirt-client
#libvirt-daemon-config-nwfilter
#libvirt-lock-sanlock
#libvirt-python
#libvirt-daemon-kvm
#iscsi-initiator-utils
#device-mapper-multipath
#qemu-kvm
#qemu-img
#glusterfs-cli
#glusterfs-fuse
#sos
#dracut
#vhostmd (with_vhostmd)
#fcoe-utils
#python-libquestfs
#glusterfs-server(with_gluster_mgmt)
#glusterfs-api(with_gluster_mgmt)
#glusterfs-geo-replication(with_gluster_mgmt)
#python-magic(with_gluster_mgmt)
#python-blivet(with_gluster_mgmt)
#xfsprogs(with_gluster_mgmt)

# Network-Manager-config-server
#This configuration file changes NetworkManager's behavior to
# what's expected on "traditional UNIX server" type deployments.
#
# See "man NetworkManager.conf" for more information about these
# and other keys.

#[main]
# Do not do automatic (DHCP/SLAAC) configuration on ethernet devices
# with no other matching connections.
#no-auto-default=*

# Ignore the carrier (cable plugged in) state when attempting to
# activate static-IP connections.
#ignore-carrier=*#


conflicts=()
replaces=()
backup=()
options=(!emptydirs)
install=$pkgname.install
source=('git+https://gerrit.ovirt.org/vdsm')
sha256sums=('SKIP')

_systemddir=/usr/lib/systemd

build() {
  cd ${srcdir}/${pkgname%%-git}
#  patch -Np0 -i ../momd.patch
  export PYTHON="$(which python3)"
  autoreconf -if
  ./configure --prefix=/usr --enable-hooks --disable-gluster-mgmt --with-smbios-manufacture='Ovirt' \
    --with-smbios-osname='Ovirt Node' --disable-ovirt-imageio --with-ovirt-vmconsole-user='vdsm' \
    --with-ovirt-vmconsole-group='kvm' --with-qemu-kvm='qemu' --with-qemu-img='qemu-img'
  make
  # Setting software_version and software_revision in dsaversion.py
  _baserelease=`echo "$pkgver" | sed 's/\([0-9]\+\(\.[0-9]\+\)\?\).*/\1/'`
#  _baseversion=`echo "%{version}" | sed 's/\([0-9]\+\(\.[0-9]\+\)\?\).*/\1/'`
  _baseversion=$_baserelease
  _rawversion=$pkgver-$pkgrel
  _site_dir=`python -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"`
  sed -i -e 's/^software_version =.*/software_version = "'"${_baseversion}"'"/' \
           -e 's/^raw_version_revision =.*/raw_version_revision = "'"${_rawversion}"'"/' \
                  -e 's/^software_revision =.*/software_revision = "'"${_baserelease}"'"/' lib/vdsm/dsaversion.py

  sed -i -e 's/@SSL_IMPLEMENTATION@/m2c/g' lib/vdsm/config.py

  sed -i -e 's\@VDSMRPCPYLIBDIR@\${_site_dir}/vdsm/rpc\g' lib/vdsm/constants.py
}

package() {
  cd ${srcdir}/${pkgname%%-git}
  make DESTDIR="$pkgdir" LIBDIR="/usr/lib" BINDIR="/usr/bin" install

  install -dDm 0755 ${pkgdir}/var/log/vdsm
  touch ${pkgdir}/var/log/vdsm/{connectivity.log,mom.log,supervdsm.log,vdsm.log}

  # Install the lvm rules
  install -Dm 0644 vdsm/storage/vdsm-lvm.rules \
                     ${pkgdir}/etc/udev/rules.d/12-vdsm-lvm.rules
  #systemd
  install -Dm 0755 init/systemd/systemd-vdsmd ${pkgdir}/${_systemddir}/systemd-vdsmd
  install -Dm 0644 init/systemd/85-vdsmd.preset ${pkgdir}/${_systemddir}/system-preset/85-vdsmd.preset

  install -Dm 0644 init/systemd/vdsm-tmpfiles.d.conf \
                     ${pkgdir}/etc/tmpfiles.d/vdsm.conf
  install -Dm 0644 init/systemd/unlimited-core.conf \
                     ${pkgdir}/etc/systemd/system/libvirtd.service.d/unlimited-core.conf
  install -Dm 0644 vdsm_hooks/fcoe/85-vdsm-hook-fcoe.preset ${pkgdir}/${_systemddir}/system-preset/
  # Install the polkit for libvirt
  install -Dm 0644 vdsm/vdsm-libvirt-access.rules \
                    ${pkgdir}/etc/polkit-1/rules.d/10-vdsm-libvirt-access.rules

# Install the libvirt hook for cleaning up the XML
  install -Dm 0755 vdsm/virt/libvirt-hook.sh \
                   ${pkgdir}/etc/libvirt/hooks/qemu

}

# vim:set ts=2 sw=2 et:
